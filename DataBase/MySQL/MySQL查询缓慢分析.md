# MySQL查询缓慢分析

## 查询流程

```
    连接管理    管理查询连接
        |
        |
    分析器      SQL词法语法分析
        |
        |
    优化器      选择索引
        |
        |
    执行器      调用引擎层接口
        |
        |
    MyISAM  InnoDB  MEMORY
```

现在最常用的是`InnoDB`。

我们就重点说这个。

`InnoDB`中，因为直接操作磁盘会比较慢，所以加了一层内存提提速，叫`buffer pool`，这里面，放了很多内存页，每一页16KB，有些内存页放的是数据库表里看到的那种一行行的数据，有些则是放的索引信息。

查询SQL到了`InnoDB`中。会根据前面优化器里计算得到的索引，去查询相应的索引页，如果不在`buffer pool`里则从磁盘里加载索引页。再通过索引页加速查询，得到数据页的具体位置。如果这些数据页不在`buffer pool`中，则从磁盘里加载进来。

这样我们就得到了我们想要的一行行数据。

### 索引相关原因

索引相关的问题，一般能用`explain`命令帮助分析。通过它能看到用了哪些索引，大概会扫描多少行之类的信息。

mysql会在优化器阶段里看下选择哪个索引，查询速度会更快。

一般主要考虑几个因素，比如：

- 选择这个索引大概要扫描多少行（rows）
- 为了把这些行取出来，需要读多少个16kb的页
- 走普通索引需要回表，主键索引则不需要，回表成本大不大？

*走了索引还是很慢*

有些sql，用explain命令看，明明是走索引的，但还是很慢。一般是两种情况：

第一种是索引区分度太低，比如网页全路径的url链接，这拿来做索引，一眼看过去全都是同一个域名，如果前缀索引的长度建得不够长，那这走索引跟走全表扫描似的，正确姿势是尽量让索引的区分度更高，比如域名去掉，只拿后面URI部分去做索引。

第二种是索引中匹配到的数据太大，这时候需要关注的是explain里的rows字段了。

它是用于预估这个查询语句需要查的行数的，它不一定完全准确，但可以体现个大概量级。

当它很大时，一般常见的是下面几种情况。

- 如果这个字段具有唯一的属性，比如电话号码等，一般是不应该有大量重复的，那可能是你代码逻辑出现了大量重复插入的操作，你需要检查下代码逻辑，或者需要加个唯一索引限制下。
- 如果这个字段下的数据就是会很大，是否需要全部拿？如果不需要，加个`limit`限制下。如果确实要拿全部，那也不能一次性全拿，今天你数据量小，可能一次取一两万都没啥压力，万一哪天涨到了十万级别，那一次性取就有点吃不消了。你可能需要分批次取，具体操作是先用`order by id`排序一下，拿到一批数据后取最大id作为下次取数据的起始位置。

### 连接数过小

Mysql的最大连接数默认是`100`, 最大可以达到`16384`。

可以通过设置mysql的`max_connections`参数，更改数据库的最大连接数。

### buffer pool太小

进了`innodb`之后，会有一层内存`buffer pool`，用于将磁盘数据页加载到内存页中，只要查询到`buffer pool`里有，就可以直接返回，否则就要走磁盘IO，那就慢了。

也就是说，如果我的`buffer pool`越大，那我们能放的数据页就越多，相应的，sql查询时就更可能命中`buffer pool`，那查询速度自然就更快了。

可以通过下面的命令查询到`buffer pool`的大小，单位是`Byte`

```sql
show global variables like 'innodb_buffer_pool_size';
```

如果想调大一点
```sql
set global innodb_buffer_pool_size = 536870912;
```

*怎么知道buffer pool是不是太小了？*

通过`show status like 'Innodb_buffer_pool_%';`可以看到跟`buffer pool`有关的一些信息。

`Innodb_buffer_pool_read_requests`表示读请求的次数。

`Innodb_buffer_pool_reads`表示从物理磁盘中读取数据的请求次数。

```
buffer pool 命中率 = 1 - (Innodb_buffer_pool_reads/Innodb_buffer_pool_read_requests) * 100%
```

一般情况下buffer pool命中率都在99%以上，如果低于这个值，才需要考虑加大innodb buffer pool的大小。

## 总结

- 数据查询过慢一般是索引问题，可能是因为选错索引，也可能是因为查询的行数太多。
- 客户端和数据库连接数过小，会限制sql的查询并发数，增大连接数可以提升速度。
- innodb里会有一层内存buffer pool用于提升查询速度，命中率一般>99%，如果低于这个值，可以考虑增大buffer pool的大小，这样也可以提升速度。
- 查询缓存（query cache）确实能为查询提速，但一般不建议打开，因为限制比较大，并且8.0以后的Mysql里已经将这个功能干掉了。